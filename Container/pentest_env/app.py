from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
import numpy as np
import keras
import logging

logging.basicConfig(level=logging.INFO)
app = FastAPI(title="ToN-IoT Federated Learning Intrusion Detector", version="1.0")

# Load semua model (atau pilih satu terbaik)
models = {
    "mlp_binary": keras.models.load_model("trained_models/mlp_binary_fedprox.h5"),
    # "cnn_binary": keras.models.load_model("trained_models/cnn_binary_fedprox.h5"),
    # tambahin yang lain kalau mau
}

class PacketFeatures(BaseModel):
    features: list[float]   # 30 features setelah preprocessing (RFE + scaling)

@app.get("/health")
async def health():
    return {"status": "healthy", "models_loaded": list(models.keys())}

@app.post("/predict/{model_name}")
async def predict(model_name: str, data: PacketFeatures):
    if model_name not in models:
        raise HTTPException(404, f"Model {model_name} not available. Choose from {list(models.keys())}")
    
    try:
        arr = np.array(data.features, dtype=np.float32).reshape(1, -1)
        pred = float(models[model_name].predict(arr, verbose=0)[0][0])
        label = "ATTACK" if pred > 0.5 else "NORMAL"
        logging.info(f"[{model_name}] Prediction: {pred:.4f} â†’ {label}")
        return {"model": model_name, "probability_attack": pred, "label": label}
    except Exception as e:
        logging.error(f"Prediction error: {e}")
        raise HTTPException(400, "Invalid features")